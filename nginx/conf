# HTTP redirect
server {
    listen 80;
    listen [::]:80;

    server_name pereverzev.pro www.pereverzev.pro;
    return 301 https://pereverzev.pro$request_uri;
}

# HTTPS redirect to pereverzev.pro
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name www.pereverzev.pro;
    return 301 https://pereverzev.pro$request_uri;

    ssl_certificate /etc/letsencrypt/live/pereverzev.pro/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pereverzev.pro/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/pereverzev.pro/chain.pem;

    include snippets/ssl-params.conf;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name pereverzev.pro;

    # SSL
    ssl_certificate /etc/letsencrypt/live/pereverzev.pro/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pereverzev.pro/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/pereverzev.pro/chain.pem;

    include snippets/ssl-params.conf;

    # Удаление последнего слэша
    rewrite ^/(.*)/$ /$1 permanent;

     location / {
          proxy_pass http://localhost:3000;
          proxy_set_header Host $host;
          proxy_read_timeout 1m;
          proxy_connect_timeout 1m;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_cache_bypass $http_upgrade;
       }
}
